<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAPDOS Response Submission</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #fdf6e3;
      color: #333;
    }
    select, input {
      font-size: 1.1em;
      margin-bottom: 1em;
    }
    #healthBar {
      width: 100%;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1em;
    }
    #healthFill {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
    }
    .output {
      font-size: 1.1em;
      margin-top: 1em;
    }
    .label {
      font-weight: bold;
    }
    #stomachImpact {
      margin-top: 0.5em;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>MAPDOS Response Submission</h1>

  <p>Choose your contestant:</p>
  <select id="userSelect"></select>

  <div id="promptDisplay"></div>

  <div id="healthBar">
    <div id="healthFill"></div>
  </div>

  <div id="userInfo"></div>

  <p><strong>Choose food to eat:</strong></p>
  <select id="foodSelect"></select>
  <div id="stomachImpact"></div>

  <input id="textInput" placeholder="Type your response here..." type="text" />
  <div class="output">
    <div>
      <span class="label">Word Count:</span>
      <span id="wordCount">0</span>
    </div>
    <div>
      <span class="label">Calorie Cost:</span>
      <span id="calorieCost">0</span>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let glyphData = {};
      let mapdosData = {};

      const select = document.getElementById("userSelect");
      const promptContainer = document.getElementById("promptDisplay");
      const healthFill = document.getElementById("healthFill");
      const userInfoContainer = document.getElementById("userInfo");

      const foodSelect = document.getElementById("foodSelect");
      const stomachImpact = document.getElementById("stomachImpact");

      const textInput = document.getElementById("textInput");
      const wordCountDisplay = document.getElementById("wordCount");
      const calorieCostDisplay = document.getElementById("calorieCost");

      // Load glyph density JSON
      fetch("https://ktgeofficial.github.io/MiniEWOW/MAPDOS/MAPDOSfontProportions.json")
        .then(res => res.json())
        .then(data => {
          glyphData = data;
        });

      // Load MAPDOS JSON from Apps Script
      fetch("https://script.google.com/macros/s/AKfycbw1iY86evimRga_XhGddO2AlQyb63srbFsSeC-31RGc5FmKir9-EyG7tUIs6PS8MDai/exec?mode=submissions")
        .then(res => res.json())
        .then(data => {
          mapdosData = data;
          populateUserDropdown(data);
          displayPrompt(data.prompt);
        });

      function populateUserDropdown(data) {
        select.innerHTML = "";
        Object.keys(data).forEach(key => {
          if (key === "prompt") return;
          const option = document.createElement("option");
          option.value = key;
          option.textContent = key;
          select.appendChild(option);
        });
        const firstUser = select.options[0]?.value;
        if (firstUser) displayUserInfo(data[firstUser]);
        select.addEventListener("change", () => {
          displayUserInfo(data[select.value]);
        });
      }

      function displayUserInfo(info) {
        if (!info) return;

        // Health bar
        const healthPercent = Math.min(100, Math.max(0, info.health));
        healthFill.style.width = (healthPercent * (100 / 99)) + "%";

        // Basic stats
        userInfoContainer.innerHTML = `
          <p><strong>Stomach:</strong> ${info.stomach}</p>
          <p><strong>Capacity:</strong> ${info.capacity}</p>
          <p><strong>Rank:</strong> ${info.rank}</p>
        `;

        // Populate food select
        foodSelect.innerHTML = "";
        const foodKeys = Object.keys(info.food);

        if (foodKeys.length > 0) {
          // "Do not eat" option
          const noneOpt = document.createElement("option");
          noneOpt.value = "none";
          noneOpt.textContent = "Do not eat any food";
          foodSelect.appendChild(noneOpt);

          // One option per food item
          foodKeys.forEach(key => {
            const item = info.food[key];
            const opt = document.createElement("option");
            opt.value = key;
            opt.id = `food-${key}`;
            opt.textContent = item.name + (item.expired ? " (EXPIRED)" : "");
            foodSelect.appendChild(opt);
          });
          foodSelect.disabled = false;
        } else {
          // No food available
          const noOpt = document.createElement("option");
          noOpt.textContent = "No food available";
          noOpt.disabled = true;
          foodSelect.appendChild(noOpt);
          foodSelect.disabled = true;
          stomachImpact.textContent = "";
        }

        // When selection changes, show stomach impact
        foodSelect.addEventListener("change", () => {
          const sel = foodSelect.value;
          if (sel === "none") {
            stomachImpact.textContent = "No food selected.";
          } else {
            const it = info.food[sel];
            stomachImpact.textContent = `Eating this will add ${it.mass} to stomach.`;
          }
        });

        // Reset impact display
        stomachImpact.textContent = "";
      }

      function displayPrompt(txt) {
        promptContainer.innerHTML = `<p><strong>Prompt:</strong> ${txt}</p>`;
      }

      function getWordCount(str) {
        return str
          .split(" ")
          .filter(w => [...w].some(ch => /\w/.test(ch)))
          .length;
      }

      function getCalorieCost(str) {
        return [...str].reduce((sum, ch) => sum + (glyphData[ch] || 0), 0);
      }

      textInput.addEventListener("input", () => {
        const t = textInput.value;
        wordCountDisplay.textContent = getWordCount(t);
        calorieCostDisplay.textContent = getCalorieCost(t);
      });
    });
  </script>
</body>
</html>
