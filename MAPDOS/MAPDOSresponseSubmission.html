<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MAPDOS Response Submission</title>
    <style>
        body { font-family: sans-serif; padding: 2em; background: #fdf6e3; color: #333; }
        textarea { width: 100%; height: 150px; font-size: 1.2em; margin-bottom: 1em; }
        .output { font-size: 1.1em; margin-top: 1em; }
        .label { font-weight: bold; }

        /* New CSS for the health bar */
        .health-bar-container {
            width: 300px;
            height: 25px;
            background-color: #ccc;
            border: 2px solid #000; /* Adds the black outline */
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .health-bar-fill {
            height: 100%;
            background-color: #fff; /* Initial color will be replaced by JS */
            width: 0;
        }
    </style>
</head>
<body>
    <h1>MAPDOS Response Submission</h1>
    <p>Choose your contestant</p>
    <select id="userSelect"></select>

    <div id="userInfo"></div>
    <p>Prompt:</p>
    <div id="promptDisplay"></div>

    <input id="textInput" placeholder="Type your response here..." type="text">
    <div class="output">
        <div><span class="label">Word Count:</span> <span id="wordCount">0</span></div>
        <div><span class="label">Calorie Cost:</span> <span id="calorieCost">0</span></div>
    </div>
    
<script>
    document.addEventListener("DOMContentLoaded", () => {
        let glyphData = {};
        let mapdosData = {};

        // Load glyph density JSON
        fetch("https://ktgeofficial.github.io/MiniEWOW/MAPDOS/MAPDOSfontProportions.json")
            .then(response => response.json())
            .then(data => {
                glyphData = data;
            });

        // Load MAPDOS JSON from Apps Script
        fetch("https://script.google.com/macros/s/AKfycbwyJSWWQCo3bZZQ7dahPebxZFsNY_mZN0n9SEIbrHTs-_GTv2hPzm9vJrkHLvgBDOF3/exec?mode=submissions")
            .then(response => response.json())
            .then(data => {
                mapdosData = data;
                console.log(data);
                populateUserDropdown(data);
                displayPrompt(data.prompt);
            });

        function populateUserDropdown(data) {
            const select = document.getElementById("userSelect");
            select.innerHTML = "";
            
            Object.keys(data).forEach(key => {
                if (key === "prompt") return;
                const option = document.createElement("option");
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            });

            const firstUser = select.options[0]?.value;
            if (firstUser) displayUserInfo(data[firstUser]);

            select.addEventListener("change", () => {
                displayUserInfo(data[select.value]);
            });
        }

        function getHealthColor(value, max) {
            const hue = (value / max) * 120;
            return `hsl(${hue}, 100%, 45%)`;
        }
        
        function displayUserInfo(info) {
            const container = document.getElementById("userInfo");
            if (!info) return;

            // Calculate percentage and color
            const healthPct = (info.health / info.capacity) * 100;
            const healthColor = getHealthColor(info.health, info.capacity);

            let html = `
                <div class="health-bar-container">
                    <div class="health-bar-fill" style="width: ${healthPct}%; background-color: ${healthColor};"></div>
                </div>
                <p><strong>Stomach:</strong> ${info.stomach}</p>
                <p><strong>Capacity:</strong> ${info.capacity}</p>
                <p><strong>Rank:</strong> ${info.rank}</p>
                <p><strong>Food Inventory:</strong></p>
                <ul>
            `;

            for (let key in info.food) {
                const item = info.food[key];
                html += `<li>${item.name} (${item.food}) â€” Mass: ${item.mass}, Expired: ${item.expired}</li>`;
            }

            html += `</ul>`;
            container.innerHTML = html;
        }

        function displayPrompt(promptText) {
            const promptContainer = document.getElementById("promptDisplay");
            promptContainer.innerHTML = `<p><strong>Prompt:</strong> ${promptText}</p>`;
        }

        const textInput = document.getElementById("textInput");
        const wordCountDisplay = document.getElementById("wordCount");
        const calorieCostDisplay = document.getElementById("calorieCost");

        function getWordCount(str) {
            const words = str.split(" ");
            let count = 0;
            for (let word of words) {
                if ([...word].some(ch => /\w/.test(ch))) {
                    count++;
                }
            }
            return count;
        }

        function getCalorieCost(str) {
            let cost = 0;
            for (let ch of str) {
                cost += glyphData[ch] || 0;
            }
            return cost;
        }

        textInput.addEventListener("input", () => {
            const text = textInput.value;
            wordCountDisplay.textContent = getWordCount(text);
            calorieCostDisplay.textContent = getCalorieCost(text);
        });
    });
</script>

</body>
</html>
