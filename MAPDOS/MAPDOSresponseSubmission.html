<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MAPDOS Response Submission â€“ Stomach Preview</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #fdf6e3;
      color: #333;
    }
    select, input {
      font-size: 1.1em;
      margin-bottom: 1em;
    }
    #healthBar {
      width: 100%;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1em;
    }
    #healthFill {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
    }
    .output {
      font-size: 1.1em;
      margin-top: 1em;
    }
    .label {
      font-weight: bold;
    }

    /* Stomach preview styling */
    #stomachContainer {
      margin: 2em 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    svg {
      width: 128px;
      height: 128px;
    }
  </style>
</head>
<body>
  <h1>MAPDOS Response Submission</h1>

  <p>Choose your contestant:</p>
  <select id="userSelect"></select>

  <div id="promptDisplay"></div>

  <div id="healthBar">
    <div id="healthFill"></div>
  </div>

  <!-- Stomach preview replaces textual stomach stats -->
  <div id="stomachContainer">
    <svg viewBox="0 0 128 128" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <clipPath id="vesselClip">
          <path d="M 56 0 H 72 V 12 C 128 12 128 116 72 116 H 40 V 128 H 24 V 104 C 24 104 84 96 56 12 V 0 Z"/>
        </clipPath>
      </defs>

      <!-- Outline -->
      <path d="M 56 0 H 72 V 12 C 128 12 128 116 72 116 H 40 V 128 H 24 V 104 C 24 104 84 96 56 12 V 0 Z"
            fill="none" stroke="black" stroke-width="4"/>

      <!-- Green (current stomach fill) -->
      <rect id="greenFill" x="0" y="128" width="128" height="0"
            fill="#00FF80" clip-path="url(#vesselClip)" />

      <!-- Yellow (selected food preview) -->
      <rect id="yellowFill" x="0" y="128" width="128" height="0"
            fill="#FFFF80" clip-path="url(#vesselClip)" />

      <!-- Red (overflow) -->
      <rect id="overflowFill" x="0" y="128" width="128" height="0"
            fill="#FE467C" clip-path="url(#vesselClip)" />
    </svg>
  </div>

  <!-- Food selection -->
  <p><strong>Choose food to eat:</strong></p>
  <select id="foodSelect"></select>

  <!-- Text response and metrics -->
  <input id="textInput" placeholder="Type your response here..." type="text" />
  <div class="output">
    <div><span class="label">Word Count:</span> <span id="wordCount">0</span></div>
    <div><span class="label">Energy Cost:</span> <span id="calorieCost">0</span></div>
  </div>

  <!-- Hidden inputs to power the SVG logic -->
  <div style="display: none;">
    <input type="number" id="capacity" />
    <input type="number" id="green" />
    <input type="number" id="yellow" />
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let glyphData = {};
      let mapdosData = {};

      const userSelect = document.getElementById("userSelect");
      const promptDisplay = document.getElementById("promptDisplay");
      const healthFill = document.getElementById("healthFill");

      const foodSelect = document.getElementById("foodSelect");

      const textInput = document.getElementById("textInput");
      const wordCountDisplay = document.getElementById("wordCount");
      const calorieCostDisplay = document.getElementById("calorieCost");

      // SVG fill elements and inputs
      const capacityInput = document.getElementById("capacity");
      const greenInput = document.getElementById("green");
      const yellowInput = document.getElementById("yellow");
      const greenFillRect = document.getElementById("greenFill");
      const yellowFillRect = document.getElementById("yellowFill");
      const overflowFillRect = document.getElementById("overflowFill");

      // Load glyph density JSON
      fetch("https://ktgeofficial.github.io/MiniEWOW/MAPDOS/MAPDOSfontProportions.json")
        .then(res => res.json())
        .then(data => glyphData = data);

      // Load MAPDOS data
      fetch("https://script.google.com/macros/s/AKfycbw1iY86evimRga_XhGddO2AlQyb63srbFsSeC-31RGc5FmKir9-EyG7tUIs6PS8MDai/exec?mode=submissions")
        .then(res => res.json())
        .then(data => {
          mapdosData = data;
          buildUserSelect(data);
          displayPrompt(data.prompt);
        });

      function buildUserSelect(data) {
        userSelect.innerHTML = "";
        Object.keys(data).forEach(key => {
          if (key === "prompt") return;
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = key;
          userSelect.appendChild(opt);
        });
        if (userSelect.options.length) {
          displayUserState(mapdosData[userSelect.value]);
        }
        userSelect.addEventListener("change", () => {
          displayUserState(mapdosData[userSelect.value]);
        });
      }

      function displayPrompt(text) {
        promptDisplay.innerHTML = `<p><strong>Prompt:</strong> ${text}</p>`;
      }

      function displayUserState(info) {
        // Health bar
        const pct = Math.min(100, Math.max(0, info.health));
        healthFill.style.width = (pct * (100 / 99)) + "%";

        // Populate food dropdown
        foodSelect.innerHTML = "";
        const keys = Object.keys(info.food);

        if (keys.length) {
          const noneOpt = document.createElement("option");
          noneOpt.value = "none";
          noneOpt.textContent = "Do not eat any food";
          foodSelect.appendChild(noneOpt);

          keys.forEach(k => {
            const item = info.food[k];
            const o = document.createElement("option");
            o.value = k;
            o.id = `food-${k}`;
            o.textContent = item.name + (item.expired ? " (EXPIRED)" : "");
            foodSelect.appendChild(o);
          });
          foodSelect.disabled = false;
        } else {
          const noOpt = document.createElement("option");
          noOpt.textContent = "No food available";
          noOpt.disabled = true;
          foodSelect.appendChild(noOpt);
          foodSelect.disabled = true;
        }

        // Initialize stomach inputs
        capacityInput.value = info.capacity;
        greenInput.value = info.stomach;
        yellowInput.value = 0;
        updateStomachSVG();

        foodSelect.onchange = () => {
          const sel = foodSelect.value;
          if (sel === "none") {
            yellowInput.value = 0;
          } else {
            const itm = info.food[sel];
            yellowInput.value = itm.mass;
          }
          updateStomachSVG();
        };
      }

      function updateStomachSVG() {
        const cap = parseFloat(capacityInput.value) || 1;
        const gr = parseFloat(greenInput.value) || 0;
        const yl = parseFloat(yellowInput.value) || 0;
        const total = gr + yl;
        const maxH = 128;

        if (total <= cap) {
          const gh = (gr / cap) * maxH;
          const yh = (yl / cap) * maxH;
          greenFillRect.setAttribute("height", gh);
          greenFillRect.setAttribute("y", maxH - gh);
          yellowFillRect.setAttribute("height", yh);
          yellowFillRect.setAttribute("y", maxH - gh - yh);
          overflowFillRect.setAttribute("height", 0);
        } else {
          greenFillRect.setAttribute("height", 0);
          yellowFillRect.setAttribute("height", 0);
          overflowFillRect.setAttribute("height", maxH);
          overflowFillRect.setAttribute("y", 0);
        }
      }

      function getWordCount(s) {
        return s.split(" ").filter(w => [...w].some(ch => /\w/.test(ch))).length;
      }

      function getCalorieCost(s) {
        return [...s].reduce((sum, c) => sum + (glyphData[c] || 0), 0);
      }

      textInput.addEventListener("input", () => {
        wordCountDisplay.textContent = getWordCount(textInput.value);
        calorieCostDisplay.textContent = getCalorieCost(textInput.value);
      });
    });
  </script>
</body>
</html>
