<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MAPDOS Response Submission</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      background: #fdf6e3;
      color: #333;
    }
    select, input {
      font-size: 1.1em;
      margin-bottom: 1em;
    }
    #healthBar {
      width: 100%;
      height: 20px;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 1em;
    }
    #healthFill {
      height: 100%;
      background-color: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
    }
    .output {
      font-size: 1.1em;
      margin-top: 1em;
    }
    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>MAPDOS Response Submission</h1>
  <p>Choose your contestant:</p>
  <select id="userSelect"></select>

  <div id="promptDisplay"></div>

  <div id="healthBar"><div id="healthFill"></div></div>

  <div id="userInfo"></div>

  <input id="textInput" placeholder="Type your response here..." type="text">
  <div class="output">
    <div><span class="label">Word Count:</span> <span id="wordCount">0</span></div>
    <div><span class="label">Calorie Cost:</span> <span id="calorieCost">0</span></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let glyphData = {};
      let mapdosData = {};

      const select = document.getElementById("userSelect");
      const userInfoContainer = document.getElementById("userInfo");
      const promptContainer = document.getElementById("promptDisplay");
      const healthFill = document.getElementById("healthFill");
      const textInput = document.getElementById("textInput");
      const wordCountDisplay = document.getElementById("wordCount");
      const calorieCostDisplay = document.getElementById("calorieCost");

      // Load glyph density JSON
      fetch("https://ktgeofficial.github.io/MiniEWOW/MAPDOS/MAPDOSfontProportions.json")
        .then(response => response.json())
        .then(data => {
          glyphData = data;
        });

      // Load MAPDOS JSON from Apps Script
      fetch("https://script.google.com/macros/s/AKfycbw1iY86evimRga_XhGddO2AlQyb63srbFsSeC-31RGc5FmKir9-EyG7tUIs6PS8MDai/exec?mode=submissions")
        .then(response => response.json())
        .then(data => {
          mapdosData = data;
          populateUserDropdown(data);
          displayPrompt(data.prompt);
        });

      function populateUserDropdown(data) {
        select.innerHTML = "";

        Object.keys(data).forEach(key => {
          if (key === "prompt") return;
          const option = document.createElement("option");
          option.value = key;
          option.textContent = key;
          select.appendChild(option);
        });

        const firstUser = select.options[0]?.value;
        if (firstUser) {
          displayUserInfo(data[firstUser]);
        }

        select.addEventListener("change", () => {
          displayUserInfo(data[select.value]);
        });
      }

      function displayUserInfo(info) {
        if (!info) return;

        // Update health bar
        const healthPercent = Math.min(100, Math.max(0, info.health));
        healthFill.style.width = healthPercent + "%";

        // Display other info
        let html = `
          <p><strong>Stomach:</strong> ${info.stomach}</p>
          <p><strong>Capacity:</strong> ${info.capacity}</p>
          <p><strong>Rank:</strong> ${info.rank}</p>
          <p><strong>Food Inventory:</strong></p>
          <ul>
        `;

        for (let key in info.food) {
          const item = info.food[key];
          html += `<li>${item.name} (${item.food}) â€” Mass: ${item.mass}, Expired: ${item.expired}</li>`;
        }

        html += `</ul>`;
        userInfoContainer.innerHTML = html;
      }

      function displayPrompt(promptText) {
        promptContainer.innerHTML = `<p><strong>Prompt:</strong> ${promptText}</p>`;
      }

      function getWordCount(str) {
        const words = str.split(" ");
        let count = 0;
        for (let word of words) {
          if ([...word].some(ch => /\w/.test(ch))) {
            count++;
          }
        }
        return count;
      }

      function getCalorieCost(str) {
        let cost = 0;
        for (let ch of str) {
          cost += glyphData[ch] || 0;
        }
        return cost;
      }

      textInput.addEventListener("input", () => {
        const text = textInput.value;
        wordCountDisplay.textContent = getWordCount(text);
        calorieCostDisplay.textContent = getCalorieCost(text);
      });
    });
  </script>
</body>
</html>
